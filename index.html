<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlipIQ Live ‚Äî Deal Analyzer & Watchlist</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,wght@0,300;0,600;0,900;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0c0f0a; --surface: #141710; --surface2: #1c2019; --border: #2a2f26;
    --accent: #c8f060; --accent2: #f0a830; --accent3: #60c8f0;
    --text: #e8ead4; --muted: #7a7f6a; --danger: #f06060; --success: #60f0a0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-weight: 300; min-height: 100vh; overflow-x: hidden; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 36px; border-bottom: 1px solid var(--border);
    position: sticky; top: 0; background: rgba(12,15,10,0.95);
    backdrop-filter: blur(14px); z-index: 100;
  }
  .logo { font-family: 'Fraunces', serif; font-weight: 900; font-size: 1.5rem; color: var(--accent); letter-spacing: -1px; }
  .logo em { color: var(--text); font-weight: 300; font-style: italic; }
  .header-right { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .api-pill { font-family: 'DM Mono', monospace; font-size: 0.58rem; padding: 3px 9px; border-radius: 2px; text-transform: uppercase; letter-spacing: 1px; border: 1px solid var(--border); color: var(--muted); transition: all 0.3s; }
  .api-pill.connected { border-color: var(--success); color: var(--success); background: rgba(96,240,160,0.07); }
  .api-pill.error { border-color: var(--danger); color: var(--danger); }
  .api-pill.loading { border-color: var(--accent2); color: var(--accent2); animation: blink 1s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* ‚îÄ‚îÄ NAV TABS ‚îÄ‚îÄ */
  .nav-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); }
  .nav-tab {
    font-family: 'DM Mono', monospace; font-size: 0.65rem; text-transform: uppercase;
    letter-spacing: 2px; padding: 13px 24px; cursor: pointer; color: var(--muted);
    border-bottom: 2px solid transparent; transition: all 0.2s; position: relative;
    display: flex; align-items: center; gap: 8px;
  }
  .nav-tab:hover { color: var(--text); }
  .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-badge {
    background: var(--accent); color: #0c0f0a; border-radius: 10px;
    padding: 1px 6px; font-size: 0.6rem; font-weight: 500; min-width: 18px; text-align: center;
  }
  .tab-badge.zero { background: var(--border); color: var(--muted); }

  /* ‚îÄ‚îÄ CONFIG BANNER ‚îÄ‚îÄ */
  .config-banner {
    background: var(--surface2); border-bottom: 1px solid var(--border);
    padding: 14px 36px; display: flex; gap: 14px; align-items: flex-end; flex-wrap: wrap;
  }
  .config-field { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 180px; }
  .config-label { font-family: 'DM Mono', monospace; font-size: 0.58rem; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
  .config-input { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 7px 11px; font-family: 'DM Mono', monospace; font-size: 0.73rem; outline: none; width: 100%; transition: border-color 0.2s; }
  .config-input:focus { border-color: var(--accent); }
  .config-input.has-key { border-color: rgba(96,240,160,0.5); }
  .key-saved-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--success); display: inline-block; }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .page { display: none; }
  .page.active { display: block; }
  .app { display: grid; grid-template-columns: 330px 1fr; min-height: calc(100vh - 160px); }
  .sidebar { border-right: 1px solid var(--border); padding: 22px 18px; overflow-y: auto; max-height: calc(100vh - 160px); position: sticky; top: 160px; }
  .main { padding: 26px 30px; }

  .section-label { font-family: 'DM Mono', monospace; font-size: 0.58rem; text-transform: uppercase; letter-spacing: 3px; color: var(--muted); margin-bottom: 10px; margin-top: 22px; }
  .section-label:first-child { margin-top: 0; }
  .input-group { margin-bottom: 10px; }
  label { display: block; font-size: 0.7rem; color: var(--muted); margin-bottom: 4px; font-family: 'DM Mono', monospace; }
  input, select, textarea { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 8px 11px; font-family: 'DM Sans', sans-serif; font-size: 0.82rem; outline: none; transition: border-color 0.2s; }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  select option { background: var(--surface2); }
  .range-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

  .btn-primary { width: 100%; background: var(--accent); color: #0c0f0a; border: none; padding: 12px; font-family: 'DM Mono', monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; margin-top: 18px; font-weight: 500; transition: all 0.2s; }
  .btn-primary:hover { background: #d8ff70; transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-ghost { background: none; border: 1px solid var(--border); color: var(--muted); padding: 7px 14px; font-family: 'DM Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.15s; }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: none; border: 1px solid rgba(240,96,96,0.3); color: var(--danger); padding: 7px 14px; font-family: 'DM Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.15s; }
  .btn-danger:hover { background: rgba(240,96,96,0.1); }

  /* ‚îÄ‚îÄ STATS BAR ‚îÄ‚îÄ */
  .stats-bar { display: grid; grid-template-columns: repeat(5,1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); margin-bottom: 22px; }
  .stat-cell { background: var(--surface); padding: 15px 17px; }
  .stat-value { font-family: 'Fraunces', serif; font-size: 1.45rem; font-weight: 600; color: var(--accent); line-height: 1; margin-bottom: 3px; }
  .stat-label { font-size: 0.62rem; color: var(--muted); font-family: 'DM Mono', monospace; text-transform: uppercase; letter-spacing: 1px; }

  /* ‚îÄ‚îÄ SOURCE BADGE ‚îÄ‚îÄ */
  .source-badge { font-size: 0.56rem; font-family: 'DM Mono', monospace; padding: 2px 5px; border-radius: 1px; text-transform: uppercase; letter-spacing: 1px; background: rgba(96,200,240,0.1); color: var(--accent3); border: 1px solid rgba(96,200,240,0.22); display: inline-block; }

  /* ‚îÄ‚îÄ PROPERTY CARDS ‚îÄ‚îÄ */
  .results-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 10px; flex-wrap: wrap; }
  .results-title { font-family: 'Fraunces', serif; font-size: 0.95rem; font-weight: 300; font-style: italic; }
  .sort-select { width: auto; font-size: 0.7rem; padding: 5px 8px; font-family: 'DM Mono', monospace; }

  .property-grid { display: grid; gap: 1px; background: var(--border); }
  .property-card { background: var(--surface); padding: 18px 20px; display: grid; grid-template-columns: 1fr auto; gap: 12px; cursor: pointer; transition: background 0.15s; border-left: 3px solid transparent; animation: slideIn 0.3s ease both; position: relative; }
  .property-card:hover { background: var(--surface2); }
  .property-card.hot { border-left-color: var(--accent); }
  .property-card.warm { border-left-color: var(--accent2); }
  .property-card.cold { border-left-color: var(--muted); }
  .property-card.watched { outline: 1px solid rgba(200,240,96,0.25); }
  @keyframes slideIn { from{opacity:0;transform:translateX(-8px)} to{opacity:1;transform:translateX(0)} }

  .prop-address { font-family: 'Fraunces', serif; font-size: 0.93rem; font-weight: 600; margin-bottom: 3px; }
  .prop-meta { font-size: 0.7rem; color: var(--muted); font-family: 'DM Mono', monospace; display: flex; gap: 10px; margin-bottom: 9px; flex-wrap: wrap; }
  .prop-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 7px; }
  .tag { font-size: 0.56rem; font-family: 'DM Mono', monospace; text-transform: uppercase; letter-spacing: 1px; padding: 2px 6px; border-radius: 1px; }
  .tag-foreclosure { background: rgba(240,168,48,0.15); color: var(--accent2); border: 1px solid rgba(240,168,48,0.3); }
  .tag-shortsale { background: rgba(240,96,96,0.15); color: var(--danger); border: 1px solid rgba(240,96,96,0.3); }
  .tag-pricedrop { background: rgba(96,240,160,0.12); color: var(--success); border: 1px solid rgba(96,240,160,0.3); }
  .tag-highvacancy { background: rgba(96,200,240,0.12); color: var(--accent3); border: 1px solid rgba(96,200,240,0.25); }
  .tag-lowincome { background: rgba(200,240,96,0.1); color: var(--accent); border: 1px solid rgba(200,240,96,0.2); }
  .tag-newlisting { background: rgba(200,200,200,0.1); color: #aaa; border: 1px solid rgba(200,200,200,0.2); }
  .tag-watched { background: rgba(200,240,96,0.12); color: var(--accent); border: 1px solid rgba(200,240,96,0.35); }

  .watch-btn {
    position: absolute; top: 14px; right: 14px;
    background: none; border: 1px solid var(--border); color: var(--muted);
    width: 28px; height: 28px; cursor: pointer; font-size: 0.85rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; border-radius: 2px; z-index: 2;
  }
  .watch-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(200,240,96,0.08); }
  .watch-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(200,240,96,0.12); }

  .score-bar { display: flex; align-items: center; gap: 7px; font-size: 0.61rem; font-family: 'DM Mono', monospace; color: var(--muted); }
  .score-track { flex:1; height:3px; background:var(--border); border-radius:2px; overflow:hidden; }
  .score-fill { height:100%; background: linear-gradient(90deg, var(--accent2), var(--accent)); border-radius:2px; transition: width 0.6s ease; }

  .prop-numbers { text-align: right; min-width: 115px; padding-right: 24px; }
  .prop-price { font-family: 'Fraunces', serif; font-size: 1.15rem; font-weight: 600; margin-bottom: 3px; }
  .prop-arv { font-size: 0.66rem; color: var(--muted); font-family: 'DM Mono', monospace; }
  .prop-roi { margin-top: 6px; font-family: 'DM Mono', monospace; font-size: 0.8rem; font-weight: 500; }
  .roi-positive { color: var(--success); }
  .roi-neutral { color: var(--accent2); }
  .roi-negative { color: var(--danger); }

  /* ‚îÄ‚îÄ WATCHLIST PAGE ‚îÄ‚îÄ */
  .watchlist-page { padding: 28px 32px; }
  .watchlist-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
  .watchlist-title { font-family: 'Fraunces', serif; font-size: 1.4rem; font-weight: 300; }
  .watchlist-title em { font-style: italic; color: var(--accent); }

  .pipeline-cols { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); margin-bottom: 28px; }
  .pipeline-col { background: var(--surface); }
  .pipeline-col-header { padding: 10px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .pipeline-col-name { font-family: 'DM Mono', monospace; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); }
  .pipeline-count { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--accent); }
  .pipeline-cards { padding: 10px; display: flex; flex-direction: column; gap: 8px; min-height: 60px; }
  .pipeline-mini {
    background: var(--surface2); border: 1px solid var(--border); padding: 10px 12px;
    cursor: pointer; transition: all 0.15s; border-left: 2px solid transparent;
  }
  .pipeline-mini:hover { border-color: var(--accent); }
  .pipeline-mini.hot { border-left-color: var(--accent); }
  .pipeline-mini.warm { border-left-color: var(--accent2); }
  .pipeline-mini-addr { font-size: 0.75rem; font-weight: 500; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .pipeline-mini-meta { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--muted); }
  .pipeline-mini-roi { font-family: 'DM Mono', monospace; font-size: 0.65rem; }

  .watched-list { display: grid; gap: 1px; background: var(--border); }
  .watched-card {
    background: var(--surface); padding: 18px 22px;
    display: grid; grid-template-columns: 1fr auto auto; gap: 16px; align-items: start;
    animation: slideIn 0.25s ease both;
  }
  .watched-card:hover { background: var(--surface2); }
  .wc-addr { font-family: 'Fraunces', serif; font-size: 0.92rem; font-weight: 600; margin-bottom: 4px; }
  .wc-meta { font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--muted); display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 8px; }
  .wc-numbers { text-align: right; min-width: 100px; }
  .wc-price { font-family: 'Fraunces', serif; font-size: 1.05rem; font-weight: 600; }
  .wc-roi { font-family: 'DM Mono', monospace; font-size: 0.75rem; margin-top: 4px; }
  .wc-actions { display: flex; flex-direction: column; gap: 6px; min-width: 110px; align-items: flex-end; }

  .stage-select {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text);
    padding: 4px 8px; font-family: 'DM Mono', monospace; font-size: 0.62rem;
    outline: none; cursor: pointer; width: 110px;
  }
  .stage-select:focus { border-color: var(--accent); }

  .wc-note-preview { font-size: 0.72rem; color: var(--muted); font-style: italic; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .wc-saved-date { font-family: 'DM Mono', monospace; font-size: 0.58rem; color: var(--muted); margin-top: 4px; }
  .wc-price-change { font-family: 'DM Mono', monospace; font-size: 0.62rem; margin-top: 2px; }
  .price-up { color: var(--danger); }
  .price-down { color: var(--success); }

  .empty-watchlist { text-align: center; padding: 80px 40px; color: var(--muted); border: 1px dashed var(--border); }
  .empty-watchlist .ei { font-size: 2.5rem; margin-bottom: 14px; opacity: 0.4; }
  .empty-watchlist h3 { font-family: 'Fraunces', serif; font-size: 1.1rem; font-style: italic; margin-bottom: 8px; color: var(--text); }

  /* ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ */
  .detail-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.78); z-index:200; backdrop-filter:blur(5px); }
  .detail-overlay.open { display:flex; align-items:center; justify-content:center; }
  .detail-panel { background:var(--surface); border:1px solid var(--border); width:740px; max-width:96vw; max-height:91vh; overflow-y:auto; animation:panelIn 0.2s ease; }
  @keyframes panelIn { from{opacity:0;transform:scale(0.97) translateY(8px)} to{opacity:1;transform:scale(1) translateY(0)} }
  .detail-header { padding:20px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
  .detail-address { font-family:'Fraunces',serif; font-size:1.25rem; font-weight:600; margin-bottom:4px; }
  .detail-header-actions { display:flex; gap:8px; align-items:center; flex-shrink:0; }
  .close-btn { background:none; border:1px solid var(--border); color:var(--muted); width:30px; height:30px; cursor:pointer; font-size:0.9rem; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
  .close-btn:hover { border-color:var(--accent); color:var(--accent); }
  .watch-toggle-btn { background:none; border:1px solid var(--border); color:var(--muted); padding:6px 12px; font-family:'DM Mono',monospace; font-size:0.62rem; text-transform:uppercase; letter-spacing:1px; cursor:pointer; transition:all 0.15s; white-space:nowrap; }
  .watch-toggle-btn:hover { border-color:var(--accent); color:var(--accent); }
  .watch-toggle-btn.watching { border-color:var(--accent); color:var(--accent); background:rgba(200,240,96,0.1); }
  .detail-body { padding:22px 24px; }
  .detail-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:20px; }
  .detail-metric { background:var(--surface2); border:1px solid var(--border); padding:13px; }
  .dm-label { font-size:0.58rem; font-family:'DM Mono',monospace; color:var(--muted); text-transform:uppercase; letter-spacing:2px; margin-bottom:4px; }
  .dm-value { font-family:'Fraunces',serif; font-size:1.25rem; font-weight:600; }
  .dm-sub { font-size:0.65rem; color:var(--muted); margin-top:3px; }
  .section-title { font-family:'Fraunces',serif; font-size:0.85rem; font-weight:600; font-style:italic; margin-bottom:9px; color:var(--accent); display:flex; align-items:center; gap:8px; }
  .waterfall { display:flex; flex-direction:column; border:1px solid var(--border); margin-bottom:18px; }
  .wf-row { display:flex; align-items:center; padding:8px 13px; font-size:0.78rem; border-bottom:1px solid rgba(42,47,38,0.35); }
  .wf-row:last-child { border-bottom:none; }
  .wf-label { flex:1; font-family:'DM Mono',monospace; color:var(--muted); font-size:0.65rem; }
  .wf-row.profit { background:rgba(96,240,160,0.06); }
  .wf-row.profit .wf-value { color:var(--success); font-family:'Fraunces',serif; font-size:1rem; }
  .rehab-table { width:100%; border-collapse:collapse; margin-bottom:18px; }
  .rehab-table th { font-family:'DM Mono',monospace; font-size:0.58rem; text-transform:uppercase; letter-spacing:2px; color:var(--muted); text-align:left; padding:6px 9px; border-bottom:1px solid var(--border); }
  .rehab-table td { padding:8px 9px; font-size:0.78rem; border-bottom:1px solid rgba(42,47,38,0.35); }
  .rehab-table .total-row td { font-family:'DM Mono',monospace; font-weight:500; color:var(--accent); border-top:1px solid var(--border); }
  .census-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:9px; margin-bottom:18px; }
  .census-cell { background:var(--surface2); border:1px solid var(--border); padding:11px; }
  .notes-area { width:100%; background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:9px; font-family:'DM Sans',sans-serif; font-size:0.78rem; resize:vertical; min-height:65px; outline:none; }
  .notes-area:focus { border-color:var(--accent); }
  .detail-footer { display:flex; gap:8px; align-items:center; margin-top:9px; flex-wrap:wrap; }
  .save-btn { background:none; border:1px solid var(--accent); color:var(--accent); padding:8px 16px; font-family:'DM Mono',monospace; font-size:0.62rem; text-transform:uppercase; letter-spacing:2px; cursor:pointer; transition:all 0.15s; }
  .save-btn:hover { background:var(--accent); color:#0c0f0a; }

  /* ‚îÄ‚îÄ LOADING / EMPTY ‚îÄ‚îÄ */
  .loading-state { text-align:center; padding:60px; }
  .loader { width:38px; height:38px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.75s linear infinite; margin:0 auto 14px; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { font-family:'DM Mono',monospace; font-size:0.7rem; color:var(--muted); }
  .loading-steps { margin-top:10px; display:flex; flex-direction:column; gap:5px; }
  .loading-step { font-size:0.66rem; font-family:'DM Mono',monospace; color:var(--muted); opacity:0.5; transition:opacity 0.3s; }
  .loading-step.active { opacity:1; color:var(--accent); }
  .loading-step.done { opacity:0.7; color:var(--success); }
  .empty-state { text-align:center; padding:65px 40px; color:var(--muted); }
  .empty-icon { font-size:2.4rem; margin-bottom:12px; opacity:0.35; }
  .empty-title { font-family:'Fraunces',serif; font-size:1.05rem; font-style:italic; margin-bottom:7px; color:var(--text); }
  .empty-sub { font-size:0.78rem; line-height:1.7; }
  .empty-sub a { color:var(--accent3); }
  .error-banner { background:rgba(240,96,96,0.1); border:1px solid rgba(240,96,96,0.3); color:var(--danger); padding:12px 16px; font-size:0.78rem; margin-bottom:14px; font-family:'DM Mono',monospace; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast { position:fixed; bottom:24px; right:24px; background:var(--surface2); border:1px solid var(--border); padding:12px 18px; font-family:'DM Mono',monospace; font-size:0.7rem; color:var(--text); z-index:500; animation:toastIn 0.2s ease; display:flex; align-items:center; gap:10px; max-width:320px; }
  .toast.success { border-color:rgba(96,240,160,0.4); }
  .toast.error { border-color:rgba(240,96,96,0.4); color:var(--danger); }
  @keyframes toastIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  @media(max-width:900px) {
    .app { grid-template-columns:1fr; }
    .sidebar { position:static; max-height:none; border-right:none; border-bottom:1px solid var(--border); }
    .stats-bar { grid-template-columns:repeat(2,1fr); }
    .detail-grid,.census-grid { grid-template-columns:1fr; }
    .pipeline-cols { grid-template-columns:repeat(2,1fr); }
    .watched-card { grid-template-columns:1fr auto; }
    .wc-numbers { display:none; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">Flip<em>IQ</em> <span style="font-size:0.62rem;color:var(--muted);font-family:'DM Mono',monospace;vertical-align:middle;margin-left:4px">Live</span></div>
  <div class="header-right">
    <div style="display:flex;gap:7px">
      <div class="api-pill" id="pill-rentcast">RentCast</div>
      <div class="api-pill connected" id="pill-census">Census ‚úì</div>
      <div class="api-pill" id="pill-google">Maps</div>
    </div>
  </div>
</header>

<!-- API CONFIG -->
<div class="config-banner">
  <div class="config-field">
    <div class="config-label">
      RentCast API Key
      <span id="rc-saved-dot" style="display:none"><span class="key-saved-dot"></span> saved</span>
      <a href="https://app.rentcast.io/app/api-keys" target="_blank" style="color:var(--accent3);font-size:0.58rem;margin-left:4px">‚Üí get free key</a>
    </div>
    <input class="config-input" type="password" id="key-rentcast" placeholder="rc_live_xxxxxxxxxxxx" oninput="onKeyInput('rentcast',this)" autocomplete="off">
  </div>
  <div class="config-field">
    <div class="config-label">
      Google Maps API Key
      <span id="gm-saved-dot" style="display:none"><span class="key-saved-dot"></span> saved</span>
      <a href="https://console.cloud.google.com/google/maps-apis/" target="_blank" style="color:var(--accent3);font-size:0.58rem;margin-left:4px">‚Üí get free key</a>
    </div>
    <input class="config-input" type="password" id="key-google" placeholder="AIzaSy... (optional)" oninput="onKeyInput('google',this)" autocomplete="off">
  </div>
  <div class="config-field" style="max-width:240px">
    <div class="config-label">Census API Key <span style="color:var(--success);font-size:0.56rem">(free, no key required)</span></div>
    <input class="config-input" type="password" id="key-census" placeholder="Optional ‚Äî leave blank" oninput="onKeyInput('census',this)" autocomplete="off">
  </div>
</div>

<!-- TABS -->
<div class="nav-tabs">
  <div class="nav-tab active" id="tab-search" onclick="switchTab('search')">‚ü∂ Deal Search</div>
  <div class="nav-tab" id="tab-watchlist" onclick="switchTab('watchlist')">
    ‚óà Watchlist
    <span class="tab-badge zero" id="watchlist-count">0</span>
  </div>
</div>

<!-- SEARCH PAGE -->
<div class="page active" id="page-search">
  <div class="app">
    <aside class="sidebar">
      <div class="section-label">Location</div>
      <div class="input-group">
        <label>City, State or ZIP Code</label>
        <input type="text" id="location" placeholder="e.g. 48201 or Detroit, MI">
      </div>
      <div class="section-label">Price Range</div>
      <div class="range-row">
        <div class="input-group"><label>Min ($)</label><input type="number" id="minPrice" value="50000"></div>
        <div class="input-group"><label>Max ($)</label><input type="number" id="maxPrice" value="300000"></div>
      </div>
      <div class="section-label">Deal Criteria</div>
      <div class="input-group"><label>Min ROI %</label><input type="number" id="minROI" value="20"></div>
      <div class="input-group"><label>Max Rehab Budget ($)</label><input type="number" id="maxRehab" value="75000"></div>
      <div class="input-group">
        <label>Min Beds</label>
        <select id="minBeds">
          <option value="0">Any</option><option value="2" selected>2+</option>
          <option value="3">3+</option><option value="4">4+</option>
        </select>
      </div>
      <div class="input-group">
        <label>Listing Type</label>
        <select id="listingType">
          <option value="all">All Active Listings</option>
          <option value="foreclosure">Foreclosures Only</option>
          <option value="short_sale">Short Sales Only</option>
        </select>
      </div>
      <div class="input-group"><label>Max Days on Market</label><input type="number" id="maxDOM" value="120"></div>
      <div class="input-group">
        <label>Results Limit</label>
        <select id="resultLimit">
          <option value="10">10 (conserve API calls)</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
        </select>
      </div>
      <div class="section-label">Rehab Estimator</div>
      <div class="input-group">
        <label>Rehab Level</label>
        <select id="rehabMethod">
          <option value="light">Light (~$20/sqft)</option>
          <option value="medium" selected>Medium (~$40/sqft)</option>
          <option value="heavy">Heavy (~$65/sqft)</option>
          <option value="full">Full Gut (~$100/sqft)</option>
        </select>
      </div>
      <button class="btn-primary" id="searchBtn" onclick="runSearch()">‚ü∂ Analyze Deals</button>
      <div style="margin-top:9px;font-size:0.62rem;color:var(--muted);font-family:'DM Mono',monospace;text-align:center;line-height:1.6">
        Requires RentCast key.<br>Census data loads free automatically.
      </div>
    </aside>
    <main class="main" id="mainContent">
      <div class="empty-state">
        <div class="empty-icon">üèö</div>
        <div class="empty-title">Enter your API keys & search</div>
        <div class="empty-sub">
          Add your <strong style="color:var(--accent)">RentCast</strong> key above ‚Äî it's remembered automatically.<br>
          <strong style="color:var(--accent3)">Census ACS</strong> data loads for free with every search.<br><br>
          RentCast free key: <a href="https://app.rentcast.io/app/api-keys" target="_blank">app.rentcast.io</a><br>
          Google Maps free key: <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- WATCHLIST PAGE -->
<div class="page" id="page-watchlist">
  <div class="watchlist-page">
    <div class="watchlist-header">
      <div>
        <div class="watchlist-title">Your <em>Watchlist</em></div>
        <div style="font-size:0.72rem;color:var(--muted);font-family:'DM Mono',monospace;margin-top:4px">Saved properties tracked by pipeline stage</div>
      </div>
      <button class="btn-ghost" onclick="clearWatchlist()" id="clearWatchBtn" style="display:none">Clear All</button>
    </div>
    <div id="pipelineView"></div>
    <div id="watchlistContent"></div>
  </div>
</div>

<!-- DETAIL OVERLAY -->
<div class="detail-overlay" id="detailOverlay" onclick="closeDetail(event)">
  <div class="detail-panel" id="detailPanel"></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ STORAGE KEYS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LS_KEYS = 'flipiq_apikeys';
const LS_WATCH = 'flipiq_watchlist';
const LS_FILTERS = 'flipiq_filters';
const LS_SEARCH = 'flipiq_lastlocation';

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const KEYS = { rentcast: '', google: '', census: '' };
let currentProps = [];
let watchlist = {};    // keyed by property id/address
let censusCache = {};
let detailPropRef = null; // track which prop is open in detail

const PIPELINE_STAGES = ['Researching', 'Offer Pending', 'Under Contract', 'Passed', 'Acquired'];
const REHAB_RATES = { light: 20, medium: 40, heavy: 65, full: 100 };

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function init() {
  // Load saved API keys
  try {
    const saved = JSON.parse(localStorage.getItem(LS_KEYS) || '{}');
    if (saved.rentcast) {
      KEYS.rentcast = saved.rentcast;
      const el = document.getElementById('key-rentcast');
      el.value = saved.rentcast;
      el.classList.add('has-key');
      document.getElementById('rc-saved-dot').style.display = 'inline-flex';
      updatePill('rentcast', 'connected');
    }
    if (saved.google) {
      KEYS.google = saved.google;
      const el = document.getElementById('key-google');
      el.value = saved.google;
      el.classList.add('has-key');
      document.getElementById('gm-saved-dot').style.display = 'inline-flex';
      updatePill('google', 'connected');
    }
    if (saved.census) {
      KEYS.census = saved.census;
      document.getElementById('key-census').value = saved.census;
    }
  } catch(e) {}

  // Load saved last location
  const lastLoc = localStorage.getItem(LS_SEARCH);
  if (lastLoc) document.getElementById('location').value = lastLoc;

  // Load saved filters
  try {
    const f = JSON.parse(localStorage.getItem(LS_FILTERS) || '{}');
    if (f.minPrice) document.getElementById('minPrice').value = f.minPrice;
    if (f.maxPrice) document.getElementById('maxPrice').value = f.maxPrice;
    if (f.minROI) document.getElementById('minROI').value = f.minROI;
    if (f.maxRehab) document.getElementById('maxRehab').value = f.maxRehab;
    if (f.minBeds) document.getElementById('minBeds').value = f.minBeds;
    if (f.maxDOM) document.getElementById('maxDOM').value = f.maxDOM;
    if (f.rehabMethod) document.getElementById('rehabMethod').value = f.rehabMethod;
    if (f.listingType) document.getElementById('listingType').value = f.listingType;
    if (f.resultLimit) document.getElementById('resultLimit').value = f.resultLimit;
  } catch(e) {}

  // Load watchlist
  try {
    watchlist = JSON.parse(localStorage.getItem(LS_WATCH) || '{}');
  } catch(e) { watchlist = {}; }

  updateWatchlistBadge();
})();

// ‚îÄ‚îÄ‚îÄ KEY INPUT HANDLER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onKeyInput(service, el) {
  KEYS[service] = el.value.trim();
  el.classList.toggle('has-key', !!el.value.trim());
  updatePill(service, el.value.trim() ? 'connected' : '');

  // Auto-save keys to localStorage
  try {
    const saved = JSON.parse(localStorage.getItem(LS_KEYS) || '{}');
    saved[service] = el.value.trim();
    localStorage.setItem(LS_KEYS, JSON.stringify(saved));
  } catch(e) {}

  if (service === 'rentcast') {
    const dot = document.getElementById('rc-saved-dot');
    dot.style.display = el.value.trim() ? 'inline-flex' : 'none';
  }
  if (service === 'google') {
    const dot = document.getElementById('gm-saved-dot');
    dot.style.display = el.value.trim() ? 'inline-flex' : 'none';
  }
}

function updatePill(service, state) {
  const pill = document.getElementById('pill-' + service);
  if (!pill) return;
  pill.className = 'api-pill' + (state ? ' ' + state : '');
  if (state === 'connected') {
    const labels = { rentcast:'RentCast ‚úì', google:'Maps ‚úì', census:'Census ‚úì' };
    pill.textContent = labels[service] || service;
  } else {
    const labels = { rentcast:'RentCast', google:'Maps', census:'Census' };
    pill.textContent = labels[service] || service;
  }
}

// ‚îÄ‚îÄ‚îÄ FILTER PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveFilters() {
  const f = {
    minPrice: document.getElementById('minPrice').value,
    maxPrice: document.getElementById('maxPrice').value,
    minROI: document.getElementById('minROI').value,
    maxRehab: document.getElementById('maxRehab').value,
    minBeds: document.getElementById('minBeds').value,
    maxDOM: document.getElementById('maxDOM').value,
    rehabMethod: document.getElementById('rehabMethod').value,
    listingType: document.getElementById('listingType').value,
    resultLimit: document.getElementById('resultLimit').value,
  };
  localStorage.setItem(LS_FILTERS, JSON.stringify(f));
  localStorage.setItem(LS_SEARCH, document.getElementById('location').value);
}

// ‚îÄ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function propId(p) {
  return (p.id || p.formattedAddress || p.addressLine1 || 'prop-' + p.price).replace(/\s+/g, '-').toLowerCase();
}

function isWatched(p) { return !!watchlist[propId(p)]; }

function toggleWatch(p, fromDetail) {
  const id = propId(p);
  if (watchlist[id]) {
    delete watchlist[id];
    showToast('Removed from watchlist', 'success');
  } else {
    watchlist[id] = {
      ...p,
      _id: id,
      _savedAt: new Date().toISOString(),
      _savedPrice: p.price,
      _stage: 'Researching',
      notes: p.notes || '',
    };
    showToast('Added to watchlist ‚óà', 'success');
  }
  localStorage.setItem(LS_WATCH, JSON.stringify(watchlist));
  updateWatchlistBadge();

  // Refresh card UI without full re-render
  const card = document.querySelector(`[data-propid="${id}"]`);
  if (card) {
    const btn = card.querySelector('.watch-btn');
    if (btn) {
      btn.classList.toggle('active', isWatched(p));
      btn.title = isWatched(p) ? 'Remove from watchlist' : 'Watch this property';
      btn.innerHTML = isWatched(p) ? '‚òÖ' : '‚òÜ';
    }
    card.classList.toggle('watched', isWatched(p));
  }

  if (fromDetail) {
    // Update the watch toggle button in detail panel
    const wtBtn = document.getElementById('detail-watch-btn');
    if (wtBtn) {
      wtBtn.className = isWatched(p) ? 'watch-toggle-btn watching' : 'watch-toggle-btn';
      wtBtn.textContent = isWatched(p) ? '‚òÖ Watching' : '‚òÜ Add to Watchlist';
    }
  }

  // If we're on watchlist tab, refresh it
  if (document.getElementById('page-watchlist').classList.contains('active')) {
    renderWatchlist();
  }
}

function updateStage(id, stage) {
  if (watchlist[id]) {
    watchlist[id]._stage = stage;
    localStorage.setItem(LS_WATCH, JSON.stringify(watchlist));
    renderWatchlist(); // re-render pipeline
  }
}

function removeFromWatchlist(id) {
  delete watchlist[id];
  localStorage.setItem(LS_WATCH, JSON.stringify(watchlist));
  updateWatchlistBadge();
  renderWatchlist();
  showToast('Removed from watchlist');
}

function clearWatchlist() {
  if (!confirm('Remove all saved properties from your watchlist?')) return;
  watchlist = {};
  localStorage.setItem(LS_WATCH, JSON.stringify(watchlist));
  updateWatchlistBadge();
  renderWatchlist();
}

function updateWatchlistBadge() {
  const count = Object.keys(watchlist).length;
  const badge = document.getElementById('watchlist-count');
  badge.textContent = count;
  badge.className = 'tab-badge' + (count === 0 ? ' zero' : '');
  const clearBtn = document.getElementById('clearWatchBtn');
  if (clearBtn) clearBtn.style.display = count > 0 ? '' : 'none';
}

function saveWatchlistNotes(id) {
  const ta = document.getElementById('wl-notes-' + id);
  if (ta && watchlist[id]) {
    watchlist[id].notes = ta.value;
    localStorage.setItem(LS_WATCH, JSON.stringify(watchlist));
    showToast('Notes saved ‚úì', 'success');
  }
}

// ‚îÄ‚îÄ‚îÄ TAB SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
  if (tab === 'watchlist') renderWatchlist();
}

// ‚îÄ‚îÄ‚îÄ RENDER WATCHLIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWatchlist() {
  updateWatchlistBadge();
  const clearBtn = document.getElementById('clearWatchBtn');
  if (clearBtn) clearBtn.style.display = Object.keys(watchlist).length > 0 ? '' : 'none';

  const items = Object.values(watchlist);
  const pipelineEl = document.getElementById('pipelineView');
  const listEl = document.getElementById('watchlistContent');

  if (items.length === 0) {
    pipelineEl.innerHTML = '';
    listEl.innerHTML = `
      <div class="empty-watchlist">
        <div class="ei">‚óà</div>
        <h3>Your watchlist is empty</h3>
        <p>Search for deals and click the ‚òÜ star icon on any property to save it here for monitoring.</p>
      </div>`;
    return;
  }

  // Pipeline view
  const byStage = {};
  PIPELINE_STAGES.forEach(s => { byStage[s] = []; });
  items.forEach(p => { const s = p._stage || 'Researching'; if (byStage[s]) byStage[s].push(p); });

  pipelineEl.innerHTML = `
    <div style="font-family:'DM Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:3px;color:var(--muted);margin-bottom:12px">Pipeline Overview</div>
    <div class="pipeline-cols">
      ${PIPELINE_STAGES.map(stage => `
        <div class="pipeline-col">
          <div class="pipeline-col-header">
            <div class="pipeline-col-name">${stage}</div>
            <div class="pipeline-count">${byStage[stage].length}</div>
          </div>
          <div class="pipeline-cards">
            ${byStage[stage].map(p => {
              const roiCls = p.roi >= 35 ? 'roi-positive' : p.roi >= 20 ? 'roi-neutral' : 'roi-negative';
              const addr = (p.formattedAddress || p.addressLine1 || 'Unknown').split(',')[0];
              return `<div class="pipeline-mini ${p.heat||''}" onclick='openWatchedDetail("${p._id}")'>
                <div class="pipeline-mini-addr">${addr}</div>
                <div class="pipeline-mini-meta">$${(p.price||0).toLocaleString()}</div>
                <div class="pipeline-mini-roi ${roiCls}">${(p.roi||0).toFixed(1)}% ROI</div>
              </div>`;
            }).join('')}
          </div>
        </div>
      `).join('')}
    </div>`;

  // Full list
  listEl.innerHTML = `
    <div style="font-family:'DM Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:3px;color:var(--muted);margin-bottom:12px;margin-top:8px">All Saved Properties</div>
    <div class="watched-list">
      ${items.sort((a,b) => new Date(b._savedAt) - new Date(a._savedAt)).map(p => {
        const roiCls = p.roi >= 35 ? 'roi-positive' : p.roi >= 20 ? 'roi-neutral' : 'roi-negative';
        const addr = p.formattedAddress || p.addressLine1 || 'Unknown';
        const savedDate = new Date(p._savedAt).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
        const priceChange = p._savedPrice && p.price !== p._savedPrice
          ? `<div class="wc-price-change ${p.price > p._savedPrice ? 'price-up' : 'price-down'}">
              ${p.price > p._savedPrice ? '‚ñ≤' : '‚ñº'} $${Math.abs(p.price - p._savedPrice).toLocaleString()} since saved
             </div>` : '';
        return `
        <div class="watched-card">
          <div>
            <div class="wc-addr" style="cursor:pointer" onclick='openWatchedDetail("${p._id}")'>${addr}</div>
            <div class="wc-meta">
              <span>${p.bedrooms||'?'}bd/${p.bathrooms||'?'}ba</span>
              ${p.squareFootage ? `<span>${p.squareFootage.toLocaleString()} sqft</span>` : ''}
              <span>${p.daysOnMarket??'?'} DOM</span>
              ${p._stage ? `<span class="tag tag-watched">${p._stage}</span>` : ''}
            </div>
            ${p.notes ? `<div class="wc-note-preview">üìù ${p.notes}</div>` : ''}
            <div class="wc-saved-date">Saved ${savedDate}</div>
          </div>
          <div class="wc-numbers">
            <div class="wc-price">$${(p.price||0).toLocaleString()}</div>
            <div class="wc-roi ${roiCls}">${(p.roi||0).toFixed(1)}% ROI</div>
            <div class="prop-arv" style="font-size:0.63rem">+$${fmtK(p.netProfit||0)} profit</div>
            ${priceChange}
          </div>
          <div class="wc-actions">
            <select class="stage-select" onchange="updateStage('${p._id}', this.value)">
              ${PIPELINE_STAGES.map(s => `<option value="${s}" ${p._stage===s?'selected':''}>${s}</option>`).join('')}
            </select>
            <button class="btn-ghost" style="font-size:0.6rem;padding:5px 10px" onclick='openWatchedDetail("${p._id}")'>View</button>
            <button class="btn-danger" style="font-size:0.6rem;padding:5px 10px" onclick="removeFromWatchlist('${p._id}')">Remove</button>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

function openWatchedDetail(id) {
  const p = watchlist[id];
  if (p) openDetailForProp(p, true);
}

// ‚îÄ‚îÄ‚îÄ CENSUS & GEOCODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getCensusData(zip) {
  if (censusCache[zip]) return censusCache[zip];
  try {
    const keyPart = KEYS.census ? `&key=${KEYS.census}` : '';
    const url = `https://api.census.gov/data/2023/acs/acs5?get=B25002_001E,B25002_003E,B19013_001E&for=zip+code+tabulation+area:${zip}${keyPart}`;
    const res = await fetch(url);
    if (!res.ok) return null;
    const data = await res.json();
    if (!data || data.length < 2) return null;
    const row = data[1];
    const total = parseInt(row[0]), vacant = parseInt(row[1]), income = parseInt(row[2]);
    const result = { vacancyRate: total > 0 ? parseFloat((vacant/total*100).toFixed(1)) : null, medianIncome: income, totalUnits: total, vacantUnits: vacant };
    censusCache[zip] = result;
    return result;
  } catch(e) { return null; }
}

function extractZip(loc) { const m = (loc||'').match(/\b(\d{5})\b/); return m ? m[1] : null; }

// ‚îÄ‚îÄ‚îÄ RENTCAST CALLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchListings(location, filters) {
  if (!KEYS.rentcast) throw new Error('No RentCast API key');
  const headers = { 'X-Api-Key': KEYS.rentcast };
  const params = new URLSearchParams();
  const zip = extractZip(location);
  if (zip) { params.set('zipCode', zip); }
  else {
    const parts = location.split(',').map(s => s.trim());
    params.set('city', parts[0]);
    if (parts[1]) params.set('state', parts[1].split(' ')[0]);
  }
  params.set('status', 'Active');
  params.set('propertyType', 'Single Family');
  if (filters.minPrice && filters.maxPrice) params.set('price', `${filters.minPrice}:${filters.maxPrice}`);
  else if (filters.minPrice) params.set('price', `${filters.minPrice}:`);
  else if (filters.maxPrice) params.set('price', `:${filters.maxPrice}`);
  if (filters.minBeds > 0) params.set('bedrooms', `${filters.minBeds}:`);
  if (filters.listingType === 'foreclosure') params.set('listingType', 'Foreclosure');
  else if (filters.listingType === 'short_sale') params.set('listingType', 'Short Sale');
  params.set('limit', filters.limit || 25);
  const url = `https://api.rentcast.io/v1/listings/sale?${params}`;
  const res = await fetch(url, { headers });
  if (res.status === 401) throw new Error('Invalid RentCast API key. Check your key and try again.');
  if (res.status === 429) throw new Error('RentCast rate limit reached. Free plan: 50 calls/month.');
  if (!res.ok) { const t = await res.text(); throw new Error(`RentCast ${res.status}: ${t}`); }
  return res.json();
}

async function fetchMarketData(zip) {
  if (!KEYS.rentcast || !zip) return null;
  try {
    const res = await fetch(`https://api.rentcast.io/v1/markets?zipCode=${zip}&dataType=Sale`, { headers: { 'X-Api-Key': KEYS.rentcast } });
    return res.ok ? res.json() : null;
  } catch(e) { return null; }
}

// ‚îÄ‚îÄ‚îÄ DEAL CALC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function estimateRehab(sqft, method) {
  const rate = REHAB_RATES[method] || 40;
  const base = (sqft || 1200) * rate;
  return [
    { name: 'Structural / Foundation', cost: Math.round(base * 0.08) },
    { name: 'Roof / Exterior', cost: Math.round(base * 0.12) },
    { name: 'Kitchen', cost: Math.round(base * 0.18) },
    { name: 'Bath(s)', cost: Math.round(base * 0.12) },
    { name: 'HVAC / Plumbing / Electric', cost: Math.round(base * 0.20) },
    { name: 'Flooring', cost: Math.round(base * 0.10) },
    { name: 'Paint & Finishes', cost: Math.round(base * 0.07) },
    { name: 'Landscaping / Curb Appeal', cost: Math.round(base * 0.05) },
    { name: 'Contingency (8%)', cost: Math.round(base * 0.08) },
  ];
}

function calcDeal(price, arv, rehabItems) {
  const rehabTotal = rehabItems.reduce((s,i) => s+i.cost, 0);
  const holdingCosts = Math.round(price * 0.03);
  const closingBuy = Math.round(price * 0.02);
  const closingSell = Math.round(arv * 0.06);
  const totalInvested = price + rehabTotal + holdingCosts + closingBuy;
  const netProfit = arv - totalInvested - closingSell;
  const roi = totalInvested > 0 ? netProfit / totalInvested * 100 : 0;
  return { rehabTotal, rehabItems, holdingCosts, closingBuy, closingSell, totalInvested, netProfit, roi, arv };
}

function calcScore(listing, deal, census) {
  let score = 0;
  if (deal.roi >= 40) score += 35; else if (deal.roi >= 25) score += 25; else if (deal.roi >= 15) score += 15; else if (deal.roi > 0) score += 5;
  const spread = deal.arv > 0 ? (deal.arv - listing.price) / deal.arv : 0;
  if (spread >= 0.4) score += 20; else if (spread >= 0.3) score += 14; else if (spread >= 0.2) score += 8;
  if ((listing.daysOnMarket||0) > 60) score += 10; else if ((listing.daysOnMarket||0) > 30) score += 5;
  if (listing.listingType === 'Foreclosure' || listing.listingType === 'Short Sale') score += 15;
  if (listing.priceHistory && listing.priceHistory.length > 0) score += 8;
  if (census) { if (census.vacancyRate >= 15) score += 7; if (census.medianIncome < 45000) score += 5; }
  return Math.min(100, score);
}

function getDistressTags(prop, census) {
  const tags = [];
  if (prop.listingType === 'Foreclosure') tags.push({ label:'Foreclosure', cls:'tag-foreclosure' });
  if (prop.listingType === 'Short Sale') tags.push({ label:'Short Sale', cls:'tag-shortsale' });
  if (prop.priceHistory && prop.priceHistory.length > 0) tags.push({ label:'Price History', cls:'tag-pricedrop' });
  if (census && census.vacancyRate >= 12) tags.push({ label:`${census.vacancyRate}% Vacancy`, cls:'tag-highvacancy' });
  if (census && census.medianIncome < 45000) tags.push({ label:'Low Income Area', cls:'tag-lowincome' });
  if ((prop.daysOnMarket||999) <= 7) tags.push({ label:'New Listing', cls:'tag-newlisting' });
  return tags;
}

// ‚îÄ‚îÄ‚îÄ MAIN SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runSearch() {
  const location = document.getElementById('location').value.trim();
  if (!location) { alert('Please enter a city, state, or ZIP code'); return; }
  if (!KEYS.rentcast) { alert('Please enter your RentCast API key at the top'); return; }
  saveFilters();

  const filters = {
    minPrice: parseInt(document.getElementById('minPrice').value) || 0,
    maxPrice: parseInt(document.getElementById('maxPrice').value) || 999999,
    minROI: parseFloat(document.getElementById('minROI').value) || 0,
    maxRehab: parseInt(document.getElementById('maxRehab').value) || 999999,
    minBeds: parseInt(document.getElementById('minBeds').value) || 0,
    maxDOM: parseInt(document.getElementById('maxDOM').value) || 999,
    listingType: document.getElementById('listingType').value,
    limit: parseInt(document.getElementById('resultLimit').value) || 25,
    rehabMethod: document.getElementById('rehabMethod').value,
  };

  const btn = document.getElementById('searchBtn');
  btn.disabled = true; btn.textContent = '‚ü≥ Searching...';
  showLoading();
  updatePill('rentcast', 'loading');

  try {
    setStep(0, 'active');
    let listings;
    try {
      listings = await fetchListings(location, filters);
      updatePill('rentcast', 'connected');
      setStep(0, 'done');
    } catch(e) {
      updatePill('rentcast', 'error');
      showError(e.message);
      btn.disabled = false; btn.textContent = '‚ü∂ Analyze Deals';
      return;
    }

    if (!listings || listings.length === 0) {
      showError('No listings found. Try a different location or loosen your price range.');
      btn.disabled = false; btn.textContent = '‚ü∂ Analyze Deals';
      return;
    }

    setStep(1, 'active');
    updatePill('census', 'loading');
    const zips = [...new Set(listings.map(l => l.zipCode).filter(Boolean))];
    const censusResults = {};
    for (const zip of zips.slice(0, 6)) {
      const d = await getCensusData(zip);
      if (d) censusResults[zip] = d;
    }
    updatePill('census', 'connected');
    setStep(1, 'done');

    setStep(2, 'active');
    const primaryZip = extractZip(location) || (zips[0] || null);
    const marketData = await fetchMarketData(primaryZip);
    setStep(2, 'done');

    setStep(3, 'active');
    const rehabMethod = filters.rehabMethod;
    const processed = [];
    for (const listing of listings) {
      if ((listing.daysOnMarket||0) > filters.maxDOM) continue;
      if ((listing.price||0) < filters.minPrice || (listing.price||0) > filters.maxPrice) continue;
      if (filters.minBeds > 0 && listing.bedrooms && listing.bedrooms < filters.minBeds) continue;
      let arv;
      if (marketData?.saleData) {
        const med = marketData.saleData.medianListingPrice || marketData.saleData.averageListingPrice;
        if (med) arv = Math.round(med * (1.05 + Math.random() * 0.15));
      }
      if (!arv) arv = Math.round((listing.price||100000) * (1.3 + Math.random() * 0.25));
      const rehabItems = estimateRehab(listing.squareFootage, rehabMethod);
      const deal = calcDeal(listing.price, arv, rehabItems);
      if (deal.roi < filters.minROI) continue;
      if (deal.rehabTotal > filters.maxRehab) continue;
      const census = censusResults[listing.zipCode] || null;
      const tags = getDistressTags(listing, census);
      const score = calcScore(listing, deal, census);
      const heat = deal.roi >= 35 ? 'hot' : deal.roi >= 22 ? 'warm' : 'cold';
      processed.push({ ...listing, ...deal, tags, score, heat, census, notes: '' });
    }
    setStep(3, 'done');

    currentProps = processed.sort((a,b) => b.roi - a.roi);
    renderResults(currentProps, marketData);
  } catch(e) {
    showError('Unexpected error: ' + e.message);
  }

  btn.disabled = false; btn.textContent = '‚ü∂ Analyze Deals';
}

// ‚îÄ‚îÄ‚îÄ LOADING UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLoading() {
  document.getElementById('mainContent').innerHTML = `
    <div class="loading-state">
      <div class="loader"></div>
      <div class="loading-text">Pulling live deal data...</div>
      <div class="loading-steps">
        <div class="loading-step" id="step-0">‚¨° Fetching listings from RentCast...</div>
        <div class="loading-step" id="step-1">‚¨° Loading Census vacancy & income data...</div>
        <div class="loading-step" id="step-2">‚¨° Fetching market statistics...</div>
        <div class="loading-step" id="step-3">‚¨° Calculating ROI & deal scores...</div>
      </div>
    </div>`;
}
function setStep(n, state) {
  const el = document.getElementById(`step-${n}`);
  if (!el) return;
  if (state === 'active') { el.className = 'loading-step active'; el.innerHTML = el.innerHTML.replace('‚¨°','‚óà'); }
  else if (state === 'done') { el.className = 'loading-step done'; el.innerHTML = el.innerHTML.replace('‚óà','‚úì'); }
}
function showError(msg) {
  document.getElementById('mainContent').innerHTML = `<div class="error-banner">‚ö† ${msg}</div>
    <div class="empty-state"><div class="empty-icon">‚ö†</div><div class="empty-title">Search failed</div><div class="empty-sub">${msg}</div></div>`;
}

// ‚îÄ‚îÄ‚îÄ RENDER RESULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResults(props, marketData) {
  const el = document.getElementById('mainContent');
  if (props.length === 0) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">No deals matched</div><div class="empty-sub">Try lowering your Min ROI %, raising Max Rehab, or a different area.</div></div>`;
    return;
  }
  const avgROI = (props.reduce((s,p)=>s+p.roi,0)/props.length).toFixed(1);
  const avgProfit = Math.round(props.reduce((s,p)=>s+p.netProfit,0)/props.length);
  const hot = props.filter(p=>p.heat==='hot').length;
  const medianMarket = marketData?.saleData?.medianListingPrice;
  el.innerHTML = `
    <div class="stats-bar">
      <div class="stat-cell"><div class="stat-value">${props.length}</div><div class="stat-label">Deals Found</div></div>
      <div class="stat-cell"><div class="stat-value">${avgROI}%</div><div class="stat-label">Avg ROI</div></div>
      <div class="stat-cell"><div class="stat-value">$${fmtK(avgProfit)}</div><div class="stat-label">Avg Profit</div></div>
      <div class="stat-cell"><div class="stat-value">${hot}</div><div class="stat-label">üî• Hot Deals</div></div>
      <div class="stat-cell"><div class="stat-value">${medianMarket?'$'+fmtK(medianMarket):'‚Äî'}</div><div class="stat-label">Market Median <span class="source-badge">RentCast</span></div></div>
    </div>
    <div class="results-header">
      <div class="results-title">${props.length} real listings analyzed</div>
      <select class="sort-select" onchange="sortResults(this.value)">
        <option value="roi">Sort: ROI ‚Üì</option>
        <option value="profit">Sort: Profit ‚Üì</option>
        <option value="price">Sort: Price ‚Üë</option>
        <option value="score">Sort: Score ‚Üì</option>
        <option value="dom">Sort: DOM ‚Üì</option>
      </select>
    </div>
    <div class="property-grid" id="propGrid">
      ${props.map((p,i) => renderCard(p,i)).join('')}
    </div>`;
}

function renderCard(p, i) {
  const id = propId(p);
  const watched = isWatched(p);
  const roiCls = p.roi >= 35 ? 'roi-positive' : p.roi >= 20 ? 'roi-neutral' : 'roi-negative';
  const tags = p.tags.map(t => `<span class="tag ${t.cls}">${t.label}</span>`).join('');
  const addr = p.formattedAddress || p.addressLine1 || 'Unknown Address';
  return `
  <div class="property-card ${p.heat}${watched?' watched':''}" data-propid="${id}" style="animation-delay:${Math.min(i*0.04,0.5)}s" onclick="openDetail(${i})">
    <div>
      <div class="prop-address">${addr}</div>
      <div class="prop-meta">
        <span>${p.bedrooms||'?'}bd/${p.bathrooms||'?'}ba</span>
        ${p.squareFootage ? `<span>${p.squareFootage.toLocaleString()} sqft</span>` : ''}
        ${p.yearBuilt ? `<span>Built ${p.yearBuilt}</span>` : ''}
        <span>${p.daysOnMarket??'?'} DOM</span>
        ${p.listingType && p.listingType!=='Standard' ? `<span class="source-badge">${p.listingType}</span>` : ''}
      </div>
      <div class="prop-tags">${tags||'<span class="tag tag-newlisting">Active</span>'}${watched?'<span class="tag tag-watched">‚òÖ Watching</span>':''}</div>
      <div class="score-bar">
        <span>DEAL SCORE</span>
        <div class="score-track"><div class="score-fill" style="width:${p.score}%"></div></div>
        <span>${p.score}/100</span>
      </div>
    </div>
    <div class="prop-numbers">
      <div class="prop-price">$${(p.price||0).toLocaleString()}</div>
      <div class="prop-arv">ARV: $${(p.arv||0).toLocaleString()}</div>
      <div class="prop-arv">Rehab: $${(p.rehabTotal||0).toLocaleString()}</div>
      <div class="prop-roi ${roiCls}">${(p.roi||0).toFixed(1)}% ROI</div>
      <div class="prop-arv" style="color:var(--success)">+$${fmtK(p.netProfit||0)} profit</div>
    </div>
    <button class="watch-btn ${watched?'active':''}" title="${watched?'Remove from watchlist':'Watch this property'}"
      onclick="event.stopPropagation(); toggleWatch(currentProps[${currentProps.indexOf ? currentProps.indexOf(currentProps.find(x=>propId(x)==='${id}')) : i}], false)">${watched?'‚òÖ':'‚òÜ'}</button>
  </div>`;
}

function sortResults(by) {
  let sorted = [...currentProps];
  if (by==='roi') sorted.sort((a,b)=>b.roi-a.roi);
  else if (by==='profit') sorted.sort((a,b)=>b.netProfit-a.netProfit);
  else if (by==='price') sorted.sort((a,b)=>a.price-b.price);
  else if (by==='score') sorted.sort((a,b)=>b.score-a.score);
  else if (by==='dom') sorted.sort((a,b)=>(b.daysOnMarket||0)-(a.daysOnMarket||0));
  document.getElementById('propGrid').innerHTML = sorted.map((p,i)=>renderCard(p,i)).join('');
}

// ‚îÄ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDetail(idx) {
  openDetailForProp(currentProps[idx], false, idx);
}

function openDetailForProp(p, fromWatchlist, idx) {
  detailPropRef = p;
  const watched = isWatched(p);
  const roiCls = p.roi >= 35 ? 'roi-positive' : p.roi >= 20 ? 'roi-neutral' : 'roi-negative';
  const addr = p.formattedAddress || p.addressLine1 || 'Unknown Address';
  const tags = (p.tags||[]).map(t=>`<span class="tag ${t.cls}">${t.label}</span>`).join('');
  const rehabRows = (p.rehabItems||[]).map(r=>`<tr><td>${r.name}</td><td style="text-align:right;font-family:'DM Mono',monospace">$${r.cost.toLocaleString()}</td></tr>`).join('');
  const rehabTotal = `<tr class="total-row"><td>TOTAL REHAB</td><td style="text-align:right">$${(p.rehabTotal||0).toLocaleString()}</td></tr>`;
  const censusHtml = p.census ? `
    <div class="section-title">Neighborhood Data <span class="source-badge">Census ACS 5yr</span></div>
    <div class="census-grid">
      <div class="census-cell"><div class="dm-label">Vacancy Rate</div><div class="dm-value" style="font-size:1.1rem">${p.census.vacancyRate??'N/A'}%</div></div>
      <div class="census-cell"><div class="dm-label">Median Income</div><div class="dm-value" style="font-size:1.1rem">$${p.census.medianIncome?.toLocaleString()??'N/A'}</div></div>
      <div class="census-cell"><div class="dm-label">Total Units</div><div class="dm-value" style="font-size:1.1rem">${p.census.totalUnits?.toLocaleString()??'N/A'}</div></div>
    </div>` : '';
  const historyHtml = p.priceHistory?.length > 0 ? `
    <div class="section-title">Price History</div>
    <div class="waterfall">
      ${p.priceHistory.map(h=>`<div class="wf-row"><span class="wf-label">${h.event||h.date||''}</span><span class="wf-value">$${h.price?.toLocaleString()||'‚Äî'}</span></div>`).join('')}
    </div>` : '';

  // Stage selector if already watched
  const stageHtml = watched ? `
    <div style="margin-top:14px">
      <div class="section-title">Pipeline Stage</div>
      <select class="stage-select" style="width:100%;max-width:200px" onchange="updateStage('${propId(p)}', this.value)">
        ${PIPELINE_STAGES.map(s=>`<option value="${s}" ${(watchlist[propId(p)]?._stage||'Researching')===s?'selected':''}>${s}</option>`).join('')}
      </select>
    </div>` : '';

  document.getElementById('detailPanel').innerHTML = `
    <div class="detail-header">
      <div style="flex:1;min-width:0">
        <div class="detail-address">${addr}</div>
        <div class="prop-meta" style="margin-bottom:5px">
          <span>${p.bedrooms||'?'}bd/${p.bathrooms||'?'}ba</span>
          ${p.squareFootage?`<span>${p.squareFootage.toLocaleString()} sqft</span>`:''}
          ${p.yearBuilt?`<span>Built ${p.yearBuilt}</span>`:''}
          <span>${p.daysOnMarket??'?'} DOM</span>
        </div>
        <div style="display:flex;gap:5px;flex-wrap:wrap">${tags}</div>
      </div>
      <div class="detail-header-actions">
        <button class="watch-toggle-btn ${watched?'watching':''}" id="detail-watch-btn" onclick="toggleWatch(detailPropRef, true)">
          ${watched?'‚òÖ Watching':'‚òÜ Add to Watchlist'}
        </button>
        <button class="close-btn" onclick="closeDetail()">‚úï</button>
      </div>
    </div>
    <div class="detail-body">
      <div class="detail-grid">
        <div class="detail-metric">
          <div class="dm-label">Ask Price <span class="source-badge">RentCast</span></div>
          <div class="dm-value">$${(p.price||0).toLocaleString()}</div>
          <div class="dm-sub">MLS listed price</div>
        </div>
        <div class="detail-metric">
          <div class="dm-label">ARV Estimate</div>
          <div class="dm-value">$${(p.arv||0).toLocaleString()}</div>
          <div class="dm-sub">Market-adjusted</div>
        </div>
        <div class="detail-metric">
          <div class="dm-label">Net Profit</div>
          <div class="dm-value ${roiCls}">$${(p.netProfit||0).toLocaleString()}</div>
          <div class="dm-sub">${(p.roi||0).toFixed(1)}% ROI</div>
        </div>
      </div>
      <div class="section-title">Profit Waterfall</div>
      <div class="waterfall">
        <div class="wf-row"><span class="wf-label">ARV (sell price)</span><span class="wf-value">$${(p.arv||0).toLocaleString()}</span></div>
        <div class="wf-row"><span class="wf-label">‚Äî Purchase Price</span><span class="wf-value" style="color:var(--danger)">-$${(p.price||0).toLocaleString()}</span></div>
        <div class="wf-row"><span class="wf-label">‚Äî Rehab Costs</span><span class="wf-value" style="color:var(--danger)">-$${(p.rehabTotal||0).toLocaleString()}</span></div>
        <div class="wf-row"><span class="wf-label">‚Äî Holding Costs (~3%)</span><span class="wf-value" style="color:var(--danger)">-$${(p.holdingCosts||0).toLocaleString()}</span></div>
        <div class="wf-row"><span class="wf-label">‚Äî Buy Closing (~2%)</span><span class="wf-value" style="color:var(--danger)">-$${(p.closingBuy||0).toLocaleString()}</span></div>
        <div class="wf-row"><span class="wf-label">‚Äî Sell Closing (~6%)</span><span class="wf-value" style="color:var(--danger)">-$${(p.closingSell||0).toLocaleString()}</span></div>
        <div class="wf-row profit"><span class="wf-label">= NET PROFIT</span><span class="wf-value">$${(p.netProfit||0).toLocaleString()}</span></div>
        <div class="wf-row"><span class="wf-label">Total Invested</span><span class="wf-value">$${(p.totalInvested||0).toLocaleString()}</span></div>
        <div class="wf-row"><span class="wf-label">ROI</span><span class="wf-value ${roiCls}">${(p.roi||0).toFixed(1)}%</span></div>
      </div>
      <div class="section-title">Rehab Breakdown</div>
      <table class="rehab-table">
        <thead><tr><th>Category</th><th style="text-align:right">Est. Cost</th></tr></thead>
        <tbody>${rehabRows}${rehabTotal}</tbody>
      </table>
      ${censusHtml}
      ${historyHtml}
      ${stageHtml}
      <div class="section-title" style="margin-top:18px">Deal Notes</div>
      <textarea class="notes-area" id="detailNotes" placeholder="Due diligence notes, inspection concerns, offer strategy...">${(watched?watchlist[propId(p)]?.notes:'')||p.notes||''}</textarea>
      <div class="detail-footer">
        <button class="save-btn" onclick="saveDetailNotes()">Save Notes</button>
        ${watched?`<button class="btn-danger" onclick="removeFromWatchlist('${propId(p)}');closeDetail()">Remove from Watchlist</button>`:''}
      </div>
    </div>`;
  document.getElementById('detailOverlay').classList.add('open');
}

function saveDetailNotes() {
  const p = detailPropRef;
  if (!p) return;
  const notes = document.getElementById('detailNotes').value;
  p.notes = notes;
  const id = propId(p);
  if (watchlist[id]) {
    watchlist[id].notes = notes;
    localStorage.setItem(LS_WATCH, JSON.stringify(watchlist));
  }
  const btn = document.querySelector('.save-btn');
  btn.textContent = '‚úì Saved';
  setTimeout(() => btn.textContent = 'Save Notes', 1500);
  showToast('Notes saved', 'success');
}

function closeDetail(e) {
  if (!e || e.target === document.getElementById('detailOverlay')) {
    document.getElementById('detailOverlay').classList.remove('open');
    detailPropRef = null;
  }
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetail(); });

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimeout;
function showToast(msg, type='') {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.body.appendChild(t);
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => t.remove(), 2200);
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtK(n) {
  if (Math.abs(n) >= 1000) return (n/1000).toFixed(1)+'K';
  return Math.round(n).toLocaleString();
}
</script>
</body>
</html>
